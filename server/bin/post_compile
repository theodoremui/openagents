#!/bin/bash
# Post-compile hook for Heroku Python buildpack
# This runs after pip install
# IMPORTANT: With monorepo buildpack (APP_BASE=server), the server/ directory
# is copied to /app BEFORE the Python buildpack runs. So /app should contain
# pyproject.toml from server/pyproject.toml.

set -e  # Exit on error (but we'll handle gracefully)

echo "-----> Post-compile hook starting"
echo "-----> Current directory: $(pwd)"
echo "-----> HOME: $HOME"

echo "-----> Installing uv package manager"
pip install uv || {
    echo "Warning: uv installation failed or already installed"
}

echo "-----> Debug: Checking for pyproject.toml in /app"
echo "-----> Contents of /app:"
ls -la /app/ 2>/dev/null | head -30 || echo "Cannot list /app"

echo "-----> Looking for pyproject.toml:"
find /app -maxdepth 2 -name "pyproject.toml" -type f 2>/dev/null || echo "pyproject.toml not found in /app"

echo "-----> Installing server dependencies with uv"
# With APP_BASE=server, monorepo buildpack copies server/ to /app
# So /app should contain pyproject.toml
WORK_DIR="/app"

# Verify we're in the right place
if [ ! -f "$WORK_DIR/pyproject.toml" ]; then
    echo "WARNING: pyproject.toml not found in $WORK_DIR"
    echo "This suggests the monorepo buildpack didn't copy files correctly"
    echo "or the buildpack order is wrong."
    echo ""
    echo "Expected: /app/pyproject.toml (copied from server/pyproject.toml)"
    echo "Actual contents of /app:"
    ls -la "$WORK_DIR" 2>/dev/null | head -20 || echo "Cannot access $WORK_DIR"
    echo ""
    echo "Since setup.py was used for installation (package already installed),"
    echo "skipping uv pip install. The package was already installed via pip from setup.py"
    echo "This is acceptable - continuing..."
    exit 0  # Don't fail - installation already succeeded via setup.py
fi

cd "$WORK_DIR"
echo "-----> Working directory: $(pwd)"
echo "-----> Found pyproject.toml: $(ls -la pyproject.toml)"

# Install server package in editable mode (matches local setup)
# Note: This is redundant if setup.py already installed it, but ensures
# all dependencies from pyproject.toml are properly installed
echo "-----> Running: uv pip install --system -e ."
if ! uv pip install --system -e .; then
    echo "Warning: uv pip install failed, but package was already installed via setup.py"
    echo "This is acceptable - continuing..."
fi

echo "-----> Installing yelp-mcp dependencies (if needed)"
# yelp-mcp is in the project root, which is one level up from /app when using monorepo buildpack
# The monorepo buildpack structure: project root -> server/ -> copied to /app
# So yelp-mcp should be at /app/../yelp-mcp (but this might not work)
# Actually, yelp-mcp might not be copied by the monorepo buildpack at all
# So we might need to skip this or handle it differently

# Try to find yelp-mcp in various locations
YELP_MCP_FOUND=false
for yelp_dir in "/app/../yelp-mcp" "/app/yelp-mcp" "$(dirname /app)/yelp-mcp"; do
    if [ -d "$yelp_dir" ] && ([ -f "$yelp_dir/pyproject.toml" ] || [ -f "$yelp_dir/uv.lock" ]); then
        echo "-----> Found yelp-mcp at: $yelp_dir"
        cd "$yelp_dir"
        if uv sync --frozen; then
            YELP_MCP_FOUND=true
            break
        else
            echo "Warning: yelp-mcp sync failed (may not be required)"
        fi
    fi
done

if [ "$YELP_MCP_FOUND" = "false" ]; then
    echo "-----> yelp-mcp directory not found, skipping (this is optional)"
fi

echo "-----> Post-compile complete successfully"
